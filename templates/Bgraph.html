<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>KBO 전략 분석</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  <style>
    body { background-color:#f5f8fb; font-family:'Segoe UI', sans-serif; }
    .chart-img { max-width:100%; width:100%; border-radius:20px; border:2px solid #e0e0e0; background:#fff; padding:1rem; box-shadow:0 4px 12px rgba(0,0,0,.05); }
    .metric-badge { display:inline-block; padding:.25em .6em; border-radius:8px; color:#fff; font-weight:bold; font-size:.7rem; box-shadow:0 1px 3px rgba(0,0,0,.12); margin-right:.4rem; margin-bottom:.2rem; flex-shrink:0; }
    .zone-최상위권 { background-color:#007bff; }
    .zone-평균_이상 { background-color:#28a745; }
    .zone-평균_이하 { background-color:#ffc107; color:#000; }
    .zone-최하위권 { background-color:#dc3545; }
    .strategy-section { background:#fff; padding:1rem; margin-bottom:1.2rem; border-radius:15px; box-shadow:0 4px 16px rgba(0,0,0,.05); transition:all .3s ease; }
    .strategy-section:hover { transform:translateY(-2px); box-shadow:0 6px 20px rgba(0,0,0,.08); }
    .category-title { font-weight:bold; font-size:1rem; margin-bottom:.6rem; color:#333; }
    .strategy-main { color:#0d6efd; font-weight:600; margin-bottom:.4rem; font-size:.82rem; line-height:1.3; }
    .diagnosis-item { font-size:1rem; margin-bottom:.3rem; padding-left:.3rem; display:flex; align-items:flex-start; line-height:1.4; flex-wrap:wrap; }
    .diagnosis-item b { font-size:.75rem; margin-right:.3rem; }
    .form-select, .btn { border-radius:12px; }
    .nav-tabs .nav-link { border-radius:10px 10px 0 0; font-weight:500; }
    .nav-tabs .nav-link.active { background-color:#e9f3ff; border-color:#dee2e6 #dee2e6 #fff; }
    .flex-layout { display:flex; gap:1.5rem; align-items:flex-start; flex-wrap:wrap; }
    .left-chart { flex:1 1 350px; max-width:450px; }
    .right-analysis { flex:2 1 700px; min-width:600px; }
    .warning-section { background:#fff3cd; border:1px solid #ffeaa7; border-radius:15px; padding:1rem; margin-top:1rem; box-shadow:0 2px 8px rgba(255,193,7,.2); }
    .warning-title { color:#856404; font-weight:bold; font-size:.95rem; margin-bottom:.5rem; display:flex; align-items:center; }
    .warning-item { color:#856404; font-size:.85rem; margin-bottom:.3rem; padding-left:1rem; }
  </style>
</head>
<body class="p-4">

  <form method="GET" class="mb-4">
    <label for="team" class="me-2 fw-semibold">구단 선택:</label>
    <select name="team" id="team" class="form-select d-inline-block w-auto" required onchange="this.form.submit()">
      {# inline if는 else가 필수! #}
      <option value="" disabled {{ 'selected' if (not analysis or not analysis.get('team')) else '' }}>팀을 선택하세요</option>
      {% for t in team_list %}
        <option value="{{ t }}" {% if analysis and analysis.get('team') == t %}selected{% endif %}>{{ t }}</option>
      {% endfor %}
    </select>
    <noscript><button type="submit" class="btn btn-primary ms-2">분석 보기</button></noscript>
  </form>

  {% if charts %}
    <ul class="nav nav-tabs" id="chartTabs" role="tablist">
      {% for category in charts.keys() %}
        <li class="nav-item" role="presentation">
          <button class="nav-link {% if loop.first %}active{% endif %}"
                  id="tab-{{ category }}" data-bs-toggle="tab"
                  data-bs-target="#tabpane-{{ category }}" type="button" role="tab">
            {{ category }}
          </button>
        </li>
      {% endfor %}
    </ul>

    <div class="tab-content mt-3" id="chartTabsContent">
      {% for category, chart_path in charts.items() %}
        <div class="tab-pane fade {% if loop.first %}show active{% endif %}" id="tabpane-{{ category }}" role="tabpanel">
          <div class="flex-layout">
            <div class="left-chart">
              <img src="{{ url_for('static', filename=chart_path) }}" class="chart-img" alt="{{ category }} 차트">
              {% if warnings and warnings.get(category) %}
                <div class="warning-section">
                  <div class="warning-title">
                    <i class="fas fa-exclamation-triangle me-2"></i>차트 분석 주의사항
                  </div>
                  {% for warning in warnings[category] %}
                    <div class="warning-item">{{ warning }}</div>
                  {% endfor %}
                </div>
              {% endif %}
            </div>

            <div class="right-analysis">
              {% set area = category %}
              <div class="strategy-section">
                <div class="category-title">{{ area }}</div>

                {% for strategy in (analysis.get('categories', {}).get(area, {}).get('main', [])) %}
                  <div class="strategy-main">[핵심 전략] {{ strategy }}</div>
                {% endfor %}

                <div>
                  {% set details = analysis.get('categories', {}).get(area, {}).get('detail', []) %}
                  {% for detail in details %}
                    {% set zone_class = detail.zone | replace(' ', '_') %}
                    <div class="diagnosis-item">
                      <span class="metric-badge zone-{{ zone_class }}">{{ detail.zone }}</span>
                      <b>[{{ detail.metric }}]</b> {{ detail.value }} → {{ detail.desc }}
                    </div>
                  {% endfor %}
                  {% if details|length == 0 %}
                    <p class="text-muted">⚠️ 현재 영역에서는 특별히 약점으로 판단되는 지표가 없습니다.</p>
                  {% endif %}
                </div>
              </div>
            </div>

          </div>
        </div>
      {% endfor %}
    </div>
  {% endif %}

  {# 빈 분석 상태 방어: analysis가 없거나 team 키가 없을 때 #}
  {% if not analysis or not analysis.get('team') %}
    <p class="text-warning mt-3"></p>
  {% endif %}

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
